From 851174f51e474f75da0bf030c729539a28999355 Mon Sep 17 00:00:00 2001
From: blacksky3 <blacksky3@tuta.io>
Date: Wed, 8 Mar 2023 22:11:32 -0500
Subject: [PATCH] fix llvm::InternalizePass

---
 src/gallium/frontends/clover/llvm/invocation.cpp | 8 ++++++++
 1 file changed, 8 insertions(+)

diff --git a/src/gallium/frontends/clover/llvm/invocation.cpp b/src/gallium/frontends/clover/llvm/invocation.cpp
index 7a50fea..b4f04d0 100644
--- a/src/gallium/frontends/clover/llvm/invocation.cpp
+++ b/src/gallium/frontends/clover/llvm/invocation.cpp
@@ -33,6 +33,9 @@
 #ifdef HAVE_CLOVER_SPIRV
 #include <LLVMSPIRVLib/LLVMSPIRVLib.h>
 #endif
+#if LLVM_VERSION_MAJOR >= 17
+#include "llvm/Transforms/IPO/Internalize.h"
+#endif
 
 #include <clang/CodeGen/CodeGenAction.h>
 #include <clang/Lex/PreprocessorOptions.h>
@@ -458,7 +461,12 @@ namespace {
       if (internalize_symbols) {
          std::vector<std::string> names =
             map(std::mem_fn(&Function::getName), get_kernels(mod));
+#if LLVM_VERSION_MAJOR <= 16
          pm.add(::llvm::createInternalizePass(
+#endif
+#if LLVM_VERSION_MAJOR >= 17
+         pm.add(::llvm::InternalizePass(
+#endif
                       [=](const ::llvm::GlobalValue &gv) {
                          return std::find(names.begin(), names.end(),
                                           gv.getName()) != names.end();
-- 
2.39.2

