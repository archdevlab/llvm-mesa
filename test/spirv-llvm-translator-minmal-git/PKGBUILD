# _     _            _        _          _____
#| |__ | | __ _  ___| | _____| | ___   _|___ /
#| '_ \| |/ _` |/ __| |/ / __| |/ / | | | |_ \
#| |_) | | (_| | (__|   <\__ \   <| |_| |___) |
#|_.__/|_|\__,_|\___|_|\_\___/_|\_\\__, |____/
#                                  |___/

#Maintainer: blacksky3 <https://github.com/blacksky3>
#Credits: Daniel Bermond <dbermond@archlinux.org>
#Credits: Bruno Pagani <archange@archlinux.org>

pkgname=spirv-llvm-translator-minimal-git
pkgdesc='Tool and a library for bi-directional translation between SPIR-V and LLVM IR (git version)'
url='https://github.com/KhronosGroup/SPIRV-LLVM-Translator'
pkgver=17.0.0
pkgrel=1
_pkgver=17.0.0
commit=e4dfa92a3b1bd57ebfdcfeed4d48dfe260387032
arch=(x86_64)
license=(custom)
depends=(llvm-libs spirv-tools)
makedepends=(git cmake llvm spirv-headers make git)
checkdepends=(python python-setuptools clang)
conflicts=(spirv-llvm-translator)
provides=(spirv-llvm-translator)
provides+=(spirv-llvm-translator-minimal-git spirv-llvm-translator-git)
source=(git+https://github.com/KhronosGroup/SPIRV-LLVM-Translator.git#commit=$commit)

pkgver(){
    cd ${srcdir}/SPIRV-LLVM-Translator
    printf $_pkgver."r%s.g%s" "$(git rev-list --count HEAD)" "$(git rev-parse --short=7 HEAD)"
}

build(){
  cd ${srcdir}/SPIRV-LLVM-Translator

  rm -rf build/

  cmake -Bbuild \
  -DBUILD_SHARED_LIBS=ON \
  -DCMAKE_BUILD_TYPE=Release \
  -DCMAKE_INSTALL_PREFIX=/usr \
  -DCMAKE_POSITION_INDEPENDENT_CODE=ON \
  -DCMAKE_SKIP_RPATH=ON \
  -DLLVM_INCLUDE_TESTS=ON \
  -DLLVM_EXTERNAL_LIT=/usr/bin/lit \
  -DLLVM_EXTERNAL_SPIRV_HEADERS_SOURCE_DIR=/usr/include/spirv/ \
  -Wno-dev

  ninja -j$(nproc) -C build/
}

package(){
  #make -C build DESTDIR="${pkgdir}" install
  #install -Dm755 build/tools/llvm-spirv/llvm-spirv -t "${pkgdir}"/usr/bin
  #install -Dm644 ${_srcname}/LICENSE.TXT -t "${pkgdir}"/usr/share/licenses/${pkgname}/

  make  -j$(nproc) DESTDIR="${pkgdir}" -C ${srcdir}/SPIRV-LLVM-Translator/build/ install
  #DESTDIR="$pkgdir" ninja $NINJAFLAGS -C ${srcdir}/SPIRV-LLVM-Translator/build/ install
  install -Dm755 ${srcdir}/SPIRV-LLVM-Translator/build/tools/llvm-spirv/llvm-spirv -t "${pkgdir}"/usr/bin
  install -Dm644 ${srcdir}/SPIRV-LLVM-Translator/LICENSE.TXT -t "${pkgdir}"/usr/share/licenses/${pkgname}/
}
sha256sums=('SKIP')
